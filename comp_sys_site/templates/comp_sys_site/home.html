{% extends "comp_sys_site/base.html" %}
{% load static %}

{% block extra_css %}
    <link type="text/css" href="{% static 'comp_sys_site/css/home.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block content %}
<h1>Rankings</h1>

<table id="rankings-table">
    <thead>
        <tr>
            <th>#</th>
            <th>Institution</th>
            <th>Total Score</th>
        </tr>
    </thead>
    <tbody>
        {% for institution, data in sorted_ranks.items %}
        <tr data-institution="{{ institution }}">
            <td>{{ forloop.counter }}</td>
            <td>{{ institution }}</td>
            <td>{{ data.total_score }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    $(document).ready(function() {
        var institutionData = {{ sorted_ranks|safe }};

        $('#rankings-table tbody tr').click(function() {
            var institution = $(this).data('institution');
            var authors = institutionData[institution].authors;

            if ($(this).next().hasClass('sub-table-row')) {
                $(this).next().remove();
            } else {
                var subTableHtml = '<tr class="sub-table-row"><td colspan="3"><table class="sub-table">';
                subTableHtml += '<thead><tr><th>Faculty</th><th>Areas</th><th>Adjusted Score</th></tr></thead>';
                subTableHtml += '<tbody>';

                if (Object.keys(authors).length > 0) {
                    for (var author in authors) {
                        var areas = Object.keys(authors[author]).join(", ");
                        var score = Object.values(authors[author]).reduce((a, b) => a + b, 0);
                        subTableHtml += '<tr><td>' + author + '</td><td>' + areas + '</td><td>' + score.toFixed(2) + '</td></tr>';
                    }
                } else {
                    subTableHtml += '<tr><td colspan="3">No data available</td></tr>';
                }

                subTableHtml += '</tbody></table></td></tr>';
                $(this).after(subTableHtml);
            }
        });
    });
</script>
{% endblock %}